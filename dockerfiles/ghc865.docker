# Base the image on Ubuntu 20.04 
FROM ubuntu:20.04 

# Image metadata
LABEL maintainer="alejandro@dpella.io"
LABEL version="0.2"
LABEL description="GHC for development"

# Set the timezone so apt-get doesn't ask for it later
ENV TZ=Europe/Stockholm
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# BASHRC for environment variables for GHC and Powerline
COPY ./otherfiles/.bashrc /root/.bashrc

# Copy the entrypoint script and make it the container's entrypoint
COPY ./otherfiles/entrypoint.sh /bin/entrypoint

# Install base system utilities and dependencies
RUN apt-get update \ 
    && \
    apt-get install -y --no-install-recommends \
         software-properties-common \ 
         sudo \ 
         ssh  \
         git  \
         wget \ 
         curl \ 
         make \ 
         lzma \ 
         libnuma-dev \
         zlib1g-dev \
	 libgmp-dev \
	 libgmp10 \
         liblzma-dev \ 
	 gcc \
	 autoconf \
	 automake \
	 gpg \
         dirmngr \
	 build-essential \
       	 lsb-release \
         gnupg2  

RUN apt-get install -y powerline \
    && \  
    apt-get install -y less \
    && \ 
    apt-get install -y vim \ 
    && \
    mkdir ~/.ssh \ 
    && \
    touch ~/.ssh/known_hosts \
    && \ 
    ssh-keyscan github.com >> ~/.ssh/known_hosts \ 
    && \ 
    chmod +x /bin/entrypoint

# install gpg keys
ARG GPG_KEY=7784930957807690A66EBDBE3786C5262ECB4A3F
RUN gpg --batch --keyserver keys.openpgp.org --recv-keys $GPG_KEY

# install ghcup
RUN \
     curl https://downloads.haskell.org/~ghcup/x86_64-linux-ghcup > /usr/bin/ghcup && \
     chmod +x /usr/bin/ghcup && \
     ghcup config set gpg-setting GPGStrict

RUN curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh


# install GHC and cabal
ARG GHC=8.10.7
ARG CABAL=3.4.0.0

RUN \
    ghcup -v install ghc --force ${GHC} && \
    ghcup -v install cabal --force ${CABAL}

# install LHS 
RUN \
    ghcup install hls 

# Cabal cache in volume
RUN mkdir -p /root/.cabal 
COPY ./otherfiles/config /root/.cabal 

# Move to the root folder
WORKDIR /root

ENTRYPOINT [ "/bin/entrypoint" ]
